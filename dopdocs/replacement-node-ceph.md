# Инструкция по замене/восстановлению одного сервера кластера ceph

[[_TOC_]]

Здесь приведена инструкция которой необходимо следовать для замены или восстановления одного сервера в кластере ceph. Эту инструкцию следует применять, если не удалось исправить неработоспособность следуя документу "Поиск и устранение неисправностей

**Принятые определения**:
- СПО КВР - СПО для управления вычислительной инфраструктурой посредством веб интерфейса в веб браузере.
- Администратор - человек, с ролью "Администратор" в СПО КВР
- Пользователи - люди и сервисы зарегистрированные в СПО КВР
- СМ - система мониторинга СПО КВР
- СЖ - система журналирования СПО КВР
- Разрешающий сигнал - система идентификации, принятая в системе мониторинга СПО КВР, информирующая об успешном завершении задачи, разрешении на выполнение задачи или показывающая состояния объекта в работоспособном состоянии

Ограничения
----

Инструкция предназначена для замены/восстановления одного сервера в кластере ceph. Сервер может иметь одну роль (MON, MDS, OSD (ram, hdd), CLI) или совмещать некоторые из них. Замена/восстановление сервера в кластер ceph требует планирования и обоснования принятия решения. При необходимости, следует получить консультационную помощь для принятия решения о замене/восстановлении сервера в кластере ceph, например у разработчиков СПО КВР. Инструкция не содержит информации по добавлению сервера в кластер ceph.

Сложности, с которыми столкнулись
----
На текущий момент нет решения по замене/восстановлению сервера MON установленного первым (сервера у которого в СПО КВР в ресурсе *ceph* параметр `$first_mon` установлен в `true`). При выходе из строя сервера MON установленного первым, необходимо отказаться от его замены/восстановления и установить один или несколько последующих MON, следуя инструкции из документа *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании второго, третьего и последующих MON.

Предварительные шаги
----

- До замены сервера необходимо удалить сертификат этого сервера с Puppet master. Для этого на сервере, выполняющем роль Puppet master выполнить:

```{.bash}
sudo puppet cert clean "fqdn"
```

где "fqdn" - FQDN сервера ceph, например, cephmon06.ppoi.ensk

- Перед заменой или восстановлением сервера, Администратор должен проконтролировать состояние кластера ceph. Желательно, чтобы состояние было `HEALTH_OK`. В некоторых случаях это возможно, например, при необходимости замены MDS, OSD, CLI. В некоторых случаях кластер не будет находится в состоянии `HEALTH_OK`, например, при необходимости замены MON. Состояние кластера необходимо смотреть в СМ, параметр `PM::Ceph::Cluster::Health`.
-При замене компоненты OSD (в нашей конфигурации она присутствует на всех серверах) необходимо оценить свободное место в кластере ceph и убедиться, что свободного места будет достаточно для сохранения данных с этого сервера. Перед отключением сервера имеющего роль OSD необходимо обеспечить, чтобы объём свободного места кластера, с учётом данных с отключаемого сервера оставался не менее 30% от всего объема кластера. Добиться наличия достаточного свободного объёма кластера можно как удалением не критичных данных, так и расширением кластера - добавлением сервера/серверов имеющих роль OSD. Для добавления сервера/серверов следуйте инструкции из документа *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании OSD. Объем свободного и занятого места необходимо оценить из параметров в СМ, содержащих в своём имени "Raw usage", например, параметр `PM::Ceph::Cluster::Raw usage`.

Основания для замены/восстановления сервера
----

- Сервер физически вышел из строя. Случился отказ в обслуживании одного или нескольких физических компонент сервера и это не позволяет его использовать.
- Произошёл программный сбой на сервере и это затрудняет или делает невозможным использовать ceph на этом сервере.
- Произошёл случай, который нельзя квалифицировать как выход из строя сервера или программный сбой, но это затрудняет использование ceph (например, замедление работы ceph, причина которого неизвестна).

По способу замены/восстановления сервера можно выделить следующие варианты:
----

- Посредством использования СПО КВР. В этом случае замена/восстановление сервера напоминает его развёртывание, описанное в документе "Инструкция по применению модуля развёртывания и настройки ceph".
- Замена/восстановление сервера в ручном режиме. Должно выполняться квалифицированными пользователями или разработчиками СПО КВР.
- Замена/восстановление сервера посредством выключения и включения кластера ceph. Не всегда эффективно при аппаратном сбое сервера. Должно применяться в случае, когда не достигли желаемого результата предыдущие два пункта или их выполнение невозможно.

Особенности MON
----

В нашем сценарии развёртывания существует два вида серверов MON. Первый вид это MON развёрнутый первым. У такого MON в web интерфейсе СПО КВР, в КСУ, в манифесте init.pp (отображается как ceph), параметр `$first_mon` установлен в `true`. Второй вид это все остальные MON, то есть развёрнутые вторым и последующие. У таких MON параметр `$first_mon` установлен в `false`.

Для замены/восстановления MON развёрнутого не первым, а также MDS, OSD, CLI
----

Для всех случаев (оснований) замены/восстановления сервера, посредством СПО КВР переразвернуть сервер с применением модулей ПО. Инструкцию по установке ОС на сервер необходимо смотреть в документации на СПО КВР. Инструкцию по развёртыванию сервера следует смотреть в документе *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании соответствующего сервера.
Следует обратить особое внимание на то, что развёртывание сервера не гарантируется, если на нём уже ранее был развёрнут ceph. Следует внимательно изучить действия и их последовательность, которые необходимо выполнить в этом случае. Действия и последовательность описаны в документе *Инструкция по применению модуля развёртывания и настройки ceph*.

Для замены/восстановления MON развёрнутого первым
----
На текущий момент нет инструкции по замене/восстановлению сервера MON установленного первым (сервера у которого в СПО КВР в ресурсе *ceph* параметр `$first_mon` установлен в `true`). При выходе из строя сервера MON установленного первым, необходимо отказаться от его замены/восстановления и установить один или несколько последующих MON, следуя
инструкции из документа *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании второго, третьего и последующих MON.

Завершающие шаги
----

- Проконтролировать состояние кластера ceph. Необходимо, чтобы состояние через некоторый промежуток времени стало `HEALTH_OK`. Промежуток времени зависит от многих факторов, в том числе от состояния кластера ceph. Состояние кластера необходимо смотреть в СМ, параметр `PM::Ceph::Cluster::Health`.

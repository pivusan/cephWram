# Инструкция по замене или восстановлению компонент кластера ceph

[[_TOC_]]

Здесь приведена инструкция которой необходимо следовать для замены или восстановления компонент кластера ceph - MON, MDS, OSD (ram, hdd), CLI. Эту инструкцию следует применять, если не удалось исправить неработоспособность компонент следуя документу "Поиск и устранение неисправностей".

**Принятые определения**:
- СПО КВР - СПО для управления вычислительной инфраструктурой посредством веб интерфейса в веб браузере.
- Администратор - человек, с ролью "Администратор" в СПО КВР
- Пользователи - люди и сервисы зарегистрированные в СПО КВР
- СМ - система мониторинга СПО КВР
- СЖ - система журналирования СПО КВР
- Разрешающий сигнал - система идентификации, принятая в системе мониторинга СПО КВР, информирующая об успешном завершении задачи, разрешении на выполнение задачи или показывающая состояния объекта в работоспособном состоянии

Ограничения
----

Инструкция предназначена для замены/восстановления компонент кластера ceph - MON, MDS, OSD, CLI. На сервере может быть установлена одна компонента (MON, MDS, OSD, CLI) или их может быть несколько. Замена/восстановление компонент в кластере ceph требует планирования и обоснования принятия решения. При необходимости, следует получить консультационную помощь для принятия решения о замене/восстановлении компонент в кластере ceph, например, у разработчиков СПО КВР. Инструкция не содержит информацию о добавлении компонент в кластер ceph.

Сложности, с которыми столкнулись
----

На текущий момент нет решения по замене/восстановлению компоненты MON развёрнутой на первом MON (на сервере у которого в СПО КВР в ресурсе *ceph* параметр `$first_mon` установлен в `true`). При выходе из строя компоненты MON развёрнутой на первом MON, необходимо отказаться от её замены/восстановления и установить одну или несколько последующих компонент MON, следуя инструкции из документа *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании второго, третьего и последующих MON.

Предварительные шаги
----

- Перед заменой или восстановлением какой либо компоненты кластера ceph, Администратор должен проконтролировать состояние кластера ceph. Желательно, чтобы состояние было `HEALTH_OK`. В некоторых случаях это возможно, например, при необходимости замены MDS, OSD, CLI. В некоторых случаях кластер не будет находится в состоянии `HEALTH_OK`, например, при необходимости замены MON. Состояние кластера необходимо смотреть в СМ, параметр `PM::Ceph::Cluster::Health`.
-При замене компоненты OSD (в нашей конфигурации она присутствует на всех серверах) необходимо оценить свободное место в кластере ceph и убедиться, что свободного места будет достаточно для сохранения данных с этого сервера. Перед отключением сервера имеющего роль OSD необходимо обеспечить, чтобы объём свободного места кластера, с учётом данных с отключаемого сервера оставался не менее 30% от всего объема кластера. Добиться наличия достаточного свободного объёма кластера можно как удалением не критичных данных, так и расширением кластера - добавлением сервера/серверов имеющих роль OSD. Для добавления сервера/серверов следуйте инструкции из документа *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании OSD. Объем свободного и занятого места необходимо оценить из параметров в СМ, содержащих в своём имени "Raw usage", например, параметр `PM::Ceph::Cluster::Raw usage`.

Основания для замены/восстановления сервера
----

- Компонента кластера ceph перестала функционировать из-за отказа в обслуживании одного или нескольких физических компонент сервера. Например, выход из строя жёсткого диска для OSD.
- Произошёл программный сбой в компоненте кластера ceph и нет возможности или не удаётся исправить неработоспособность следуя документу "Поиск и устранение неисправностей".
- Произошёл случай, который нельзя квалифицировать ни как выход из строя компоненты кластера ceph из-за отказа в обслуживании одного или нескольких физических компонент сервера, ни как программный сбой, но это затрудняет использование ceph (например, замедление работы ceph, причина которого неизвестна).

По способу замены/восстановления можно выделить следующее:
----

- Посредством использования СПО КВР. В этом случае замена/восстановление компоненты кластера ceph напоминает её развёртывание, описанное в документе "Инструкция по применению модуля развёртывания и настройки ceph".
- Замена/восстановление сервера в ручном режиме. Должно выполняться квалифицированными пользователями или разработчиками СПО КВР.
- Замена/восстановление компоненты кластера ceph посредством выключения и включения кластера ceph. Не всегда эффективно при аппаратном сбое сервера. Должно применяться в случае, когда не достигли желаемого результата предыдущие два пункта или их выполнение невозможно.

Особенности MON
----

В нашем сценарии развёртывания существует два вида серверов MON. Первый вид это MON развёрнутый первым. У такого MON в web интерфейсе СПО КВР, в КСУ, в манифесте init.pp (отображается как ceph), параметр `$first_mon` установлен в `true`. Второй вид это все остальные MON, то есть развёрнутые вторым и последующие. У таких MON параметр `$first_mon` установлен в `false`.

Для замены/восстановления компоненты MON развёрнутой не на первом MON, а также компонент MDS, OSD, CLI
----

Для всех случаев (оснований) замены/восстановления компонент кластера ceph, посредством СПО КВР необходимо сначала удалить соответствующую компоненту, а затем развернуть её.

Для удаления:

* В web интерфейсе СПО КВР, зайти на сетевой узел где развёрнута компонента, которую необходимо заменить/восстановить
* В ресурсе `ceph::"Component"` установить параметр `$ensure` в `absent`.

где "Component" это компонента, которую необходимо заменить/восстановить. Одна из MON, MDS, OSD, CLI. Имя ресурса, например, для CLI будет - `ceph::cli`

* Нажать кнопку Обновить на этом сетевом узле

Для развёртывания:

* В web интерфейсе СПО КВР, зайти на сетевой узел где развёрнута компонента, которую необходимо заменить/восстановить
* В ресурсе `ceph::"Component"` установить параметр `$ensure` в `running`.

где "Component" это компонента, которую необходимо заменить/восстановить. Одна из MON, MDS, OSD, CLI. Имя ресурса, например, для CLI будет - `ceph::cli`

* Нажать кнопку Обновить на этом сетевом узле

Для замены/восстановления компоненты MON развёрнутой на первом MON
----
На текущий момент нет решения по замене/восстановлению компоненты MON развёрнутой на первом MON (на сервере у которого в СПО КВР в ресурсе *ceph* параметр `$first_mon` установлен в `true`). При выходе из строя компоненты MON развёрнутой на первом MON, необходимо отказаться от её замены/восстановления и установить одну или несколько последующих компонент MON, следуя инструкции из документа *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании второго, третьего и последующих MON.

Завершающие шаги
----

- Проконтролировать состояние кластера ceph. Необходимо, чтобы состояние через некоторый промежуток времени стало `HEALTH_OK`. Промежуток времени зависит от многих факторов, в том числе от состояния кластера ceph. Состояние кластера необходимо смотреть в СМ, параметр `PM::Ceph::Cluster::Health`.

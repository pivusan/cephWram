# Инструкция по удалению компонент из кластера ceph

[[_TOC_]]

Здесь приведена инструкция которой необходимо следовать для удаления одной ранее развёрнутой компоненты из кластера ceph

**Принятые определения**:
- СПО КВР - СПО для управления вычислительной инфраструктурой посредством веб интерфейса в веб браузере.
- Администратор - человек, с ролью "Администратор" в СПО КВР
- Пользователи - люди и сервисы зарегистрированные в СПО КВР
- СМ - система мониторинга СПО КВР
- СЖ - система журналирования СПО КВР
- Разрешающий сигнал - система идентификации, принятая в системе мониторинга СПО КВР, информирующая об успешном завершении задачи, разрешении на выполнение задачи или показывающая состояния объекта в работоспособном состоянии

Ограничения
----

Инструкция предназначена для удаления одной ранее развёрнутой компоненты из кластера ceph. Не рекомендуется удалять сразу более одной компоненты. Это может привести к потере данным. Удаление двух OSD на разных серверах может привести к отказам в обслуживании кластера ceph, удаление трех и более OSD на разных серверах с большой вероятностью (в случае, если конфигурация отказоустойчивости кластера допускает выхода из строя только двух серверов) приведёт к потере данным. Удаление компоненты из кластера ceph требует планирования и обоснованности принятия решения. Удаление компонент кластера ceph приводит к понижению доступности и отказоустойчивости. Не рекомендуется, например, уменьшать количество компонент MON и MDS менее трёх. По необходимости, следует получить консультационную помощь для принятия решения удаления сервера из кластера ceph.

Сложности, с которыми столкнулись
----

Предварительные шаги
----

- Перед удалением компоненты кластера ceph Администратор должен проконтролировать состояние кластера ceph. Необходимо, чтобы состояние было `HEALTH_OK`. Состояние кластера необходимо смотреть в СМ, параметр `PM::Ceph::Cluster::Health`.
-При удалении компоненты OSD (в нашей конфигурации она присутствует на всех серверах) необходимо оценить свободное место в кластере ceph и убедиться, что свободного места будет достаточно для сохранения данных. Перед удалением компоненты OSD необходимо обеспечить, чтобы объём свободного места кластера, с учётом данных с этого OSD оставался не менее 30% от всего объема кластера. Добиться наличия достаточного свободного объёма кластера можно как удалением не критичных данных, так и расширением кластера - добавлением сервера/серверов имеющих роль OSD. Для добавления сервера/серверов следуйте инструкции из документа *Инструкция по применению модуля развёртывания и настройки ceph*, раздел о развёртывании OSD. Объем свободного и занятого места необходимо оценить из параметров в СМ, содержащих в своём имени "Raw usage", например, параметр `PM::Ceph::Cluster::Raw usage`.

Основания для удаления компоненты
----

- Уменьшение дискового пространства в кластере ceph
- Уменьшение доступности сервисов ceph связанное с тем, что остающиеся сервисы справляются со всеми возможными нагрузками и получаемая в результате удаления сервера отказоустойчивость достаточна

По способу удаления сервера можно выделить следующие варианты:
----

- Посредством использования СПО КВР. В этом случае удаление компоненты напоминает её развёртывание, описанное в документе "Инструкция по применению модуля развёртывания и настройки ceph".
- Удаление компоненты в ручном режиме. Должно выполняться квалифицированными пользователями или разработчиками СПО КВР.

Особенности MON
----

В нашем сценарии развёртывания существует два вида серверов MON. Первый вид это MON развёрнутый первым. У такого MON в web интерфейсе СПО КВР, в КСУ, в манифесте init.pp (отображается как ceph), параметр `$first_mon` установлен в `true`. Второй вид это все остальные MON, то есть развёрнутые вторым и последующие. У таких MON параметр `$first_mon` установлен в `false`.

Для удаления компоненты MON, развёрнутой не первым, а также компонент MDS, OSD, CLI (и их любых совмещений)
----

Для всех случаев (оснований) удаления сервера, посредством СПО КВР необходимо:

* В web интерфейсе СПО КВР, зайти на сетевой узел который необходимо удалить
* В ресурсе `ceph::"Component"` установить параметр `$ensure` в `absent`.

где "Component" это та компонента, которую необходимо удалить на этом сервере, например, MON, MDS, OSD, CLI. Имя ресурса, например, для CLI будет - `ceph::cli`

* Нажать кнопку Обновить на этом сетевом сервере

Завершающие шаги
----

- Проконтролировать состояние кластера ceph. Необходимо, чтобы состояние через некоторый промежуток времени стало `HEALTH_OK`. Промежуток времени зависит от типа удаляемой компоненты, объёма данных в кластере ceph, объёма свободного пространства на кластере ceph, состояние кластера ceph и д.р. Состояние кластера необходимо смотреть в СМ, параметр `PM::Ceph::Cluster::Health`.
